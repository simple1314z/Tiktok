<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TikTok Downloader (iOS friendly)</title>

<style>
body{
    margin:0;
    font-family:Arial;
    background:#0f0f0f;
    color:white;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}
.container{
    width:100%;
    max-width:420px;
    padding:20px;
    text-align:center;
}
h1{margin-bottom:20px;}
input{
    width:100%;
    padding:12px;
    border:none;
    border-radius:8px;
    background:#1e1e1e;
    color:white;
    margin-bottom:10px;
    box-sizing: border-box;
}
button{
    width:100%;
    padding:12px;
    border:none;
    border-radius:8px;
    background:#ff0050;
    color:white;
    cursor:pointer;
    margin-top:5px;
    font-weight:bold;
}
.preview{
    margin-top:20px;
}
.preview img{
    width:100%;
    border-radius:12px;
}
.btn{
    display:block;
    margin-top:10px;
    padding:12px;
    background:#00ffcc;
    color:black;
    text-decoration:none;
    border-radius:8px;
    font-weight:bold;
    border: none;
    width: 100%;
    cursor: pointer;
}
.btn.watermark{
    background:#444;
    color:white;
}
.loader{
    margin-top:15px;
    color: #888;
}
.instruction{
    font-size: 0.9em;
    color: #aaa;
    margin-top: 15px;
    padding: 10px;
    background: #1e1e1e;
    border-radius: 8px;
}
</style>
</head>

<body>
<div class="container">

<h1>TikTok Downloader</h1>

<input type="text" id="url" placeholder="Paste TikTok URL">
<button onclick="downloadVideo()">Download</button>

<div class="loader" id="loader"></div>
<div class="preview" id="result"></div>
<div id="fallbackMsg" class="instruction" style="display: none;"></div>

</div>

<script>

async function downloadVideo() {
    const url = document.getElementById("url").value.trim();
    const loader = document.getElementById("loader");
    const result = document.getElementById("result");
    const fallbackMsg = document.getElementById("fallbackMsg");

    result.innerHTML = "";
    fallbackMsg.style.display = "none";
    loader.innerHTML = "Loading...";

    if (!url) {
        loader.innerHTML = "";
        result.innerHTML = "Please paste a TikTok URL.";
        return;
    }

    try {
        const response = await fetch("https://tikwm.com/api/?url=" + encodeURIComponent(url));
        const data = await response.json();
        loader.innerHTML = "";

        if (data.data) {
            result.innerHTML = `
                <img src="${data.data.cover}">
                <button class="btn" onclick="forceDownload('${data.data.play}', 'no_watermark.mp4')">
                    üì• Download No Watermark
                </button>
                <button class="btn watermark" onclick="forceDownload('${data.data.wmplay}', 'with_watermark.mp4')">
                    üíß Download With Watermark
                </button>
            `;
        } else {
            result.innerHTML = "Video not found. Check the URL.";
        }
    } catch (error) {
        loader.innerHTML = "";
        result.innerHTML = "Error fetching video. Try again.";
    }
}

async function forceDownload(videoUrl, filename) {
    // Show a temporary loading indicator
    const loader = document.getElementById("loader");
    loader.innerHTML = "Preparing download...";

    try {
        // Attempt to fetch the video as a blob (requires CORS support from the CDN)
        const response = await fetch(videoUrl, {
            mode: 'cors',
            headers: { 'Accept': 'video/mp4,video/*' }
        });

        if (!response.ok) throw new Error('Server refused download');

        const blob = await response.blob();
        const blobUrl = window.URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename;      // forces download on compatible browsers
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(blobUrl);

        loader.innerHTML = ""; // clear loading
    } catch (error) {
        console.warn('Blob download failed, using fallback:', error);
        loader.innerHTML = "";

        // Fallback: open video in new tab (plays on iPhone)
        window.open(videoUrl, '_blank');

        // Show iOS‚Äëspecific instructions
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            document.getElementById("fallbackMsg").innerHTML =
                "‚ö†Ô∏è Automatic download didn't work. In the new tab, <strong>tap and hold the video</strong> then choose <strong>Save Video</strong> or <strong>Download Linked File</strong>.";
            document.getElementById("fallbackMsg").style.display = "block";
        } else {
            // For other devices, maybe the browser still shows the video ‚Äì give a hint
            document.getElementById("fallbackMsg").innerHTML =
                "‚ö†Ô∏è The video opened in a new tab. Right‚Äëclick (or long‚Äëpress) and select 'Save video as...' to download.";
            document.getElementById("fallbackMsg").style.display = "block";
        }
    }
}

</script>

</body>
</html>
